
///////////////////////////////////////////////////////////////////////////////
//  GAMEHUD UI -- MAKE CHANGES AT THY OWN PERIL                              //
///////////////////////////////////////////////////////////////////////////////

newui "ghud" [
	uiallowinput 0
	uiclamp.e

	if (|| $editing $mainmenu $hidehud) [] [
		local x cn
		if (isspectator $getclientnum) [
			cn = $getfollow
		] [ cn = $getclientnum ]
		x = (maxf 0 (-f $uiaspect $uiWideHUD))
		if (>f $x 0) [ x = (*f $x 0.5) ]

		uispace $uiPad:L $uiPad:L [ // killfeed display group
			uivlist 0 [
				local i timestamp
				looplistrev n $fragQueue [
					case $i 0 [ timestamp = $n ] 1 [
						do [ .killfeed.row @n ]
					] ; i = (mod (+ $i 1) 3)
				]
			]
		] ; uialign- 1 -1

		uispace (+f $uiPad:3XL $x) $uiPad:3XL [ // game HUD group
			//uioutline (rnd 0xFFFFFF) ; uiclamp-e // debug boundary outline
			
			if (|| [< $cn 0] [isdead $cn]) [] [
				uihlist 0 [
					// resource (shield/health) display group
					uivlist 0 [
						if (& $getmutators 1) [
							.resource.bar $uiPad:D6XL (getclientshield $cn) 200 shield 0xFF8C00 0xBD6300 0xFFDC2F 1.3
							uifill 0 $uiPad:S
						]
						.resource.bar $uiPad:DSXL (getclienthealth $cn) 100 health 0x006D46 0x00AB77 0x0EEB00 1.5
					]
					// powerup and duration display group
					pushif cp (getclientpowerup $cn) [
						uifill $uiPad:2XL
						uiFastImgStretched (fade 0.5) "hud/" "shelf" "" [
							uialign -2 1
							uispace $uiPad:M $uiPad:S [
								uivlist $uiPad:L [
									uiFastImg "" "hud/" (at [
										doubledmg haste armor infammo
										agility invulnerability
									] (- $cp 1)) "" (-f $uiPad:DXL $uiPad:M)
									.resource.bar $uiPad:DXL (getclientpowerupmillis $cn) (? (= $cp 6) 15000 30000) "" 0x00B5E8 0x098BE2 0x54E0FF
								]
							]
						] $uiPad:5XL
					]
				] ; uialign- -1 1
				if 0 [ // flag hold group // XXX incomplete due to lack of detect func
					uiFastImgStretched (fade 0.5) "hud/" "shelf" "" [
						uialign 1
						uispace $uiPad:M $uiPad:M [
							pushif n (getclientteam $cn) [
								n = (? (- $n 1) "blue" "red")
								uiFastImg "" "hud/" "flag_" $n $uiPad:DXL
							]
						]
					] $uiPad:5XL
				]
				if 1 [
					uihlist $uiPad:L [ // temp ammo group
						uiFastImg "" "hud/" (at [
							shotgun smg pulse rocket railgun pistol
						] (getclientweapon $cn)) "" $uiPad:DM
						uiclip 0 $uiPad:DM [
							uifonttext "wide" "    " 2.08
							uiFancyText "wide" (getclientammo $cn) 2
							uialign- -1
						]
					] ; uialign- 1 1
				] [
					uispace $uiPad:L 0 [ // to-be-eventually ammo group
						push n (at [shotgun smg pulse rocket railgun pistol] (getclientweapon $num)) [
							uiShadowImg "" "hud/" $n "_raw" (*f (gettexaspectwh (
								concatword "data/interface/hud/" $n "_raw.png"
							)) $uiPad:DS) $uiPad:DS 2.5
						]
						uiFancyText "wide" (getclientammo $cn) 2
						uialign- 1 1
					] ; uialign- 1 1
				]
			]
		] ; uiclamp-x ; uialign- -1 1
	]
] [ uiBitsHUD = 0 ]

// use: 1:WIDTH  2:VALUE  3:MAXVAL 4:ICON  5:COL1  6:COL2  7:COL3
.resource.bar = [
	local h x y
	h = (divf $arg1 10)
	x = (+f $uiPad:O4- $arg1)
	y = (+f $uiPad:O4- $h)

	if $arg4 [
		uifill (+f $arg1 $h) 0 [
			uivlist 0 [
				uispace $uiPad:O3 $uiPad:S- [
					uiFancyText "wide" $arg2 (*f $arg1 3.125) $arg7
				] ; uialign- 1
				uicolor 0 $arg1 $h [
					uicolor $arg6 $x $y [ if $arg2 [
						uihlist 0 [
							uiclip (minf $x (%f (max 0 $arg2) $arg3 $x)) $y [
								uihgradient $arg5 $arg7 $x $y
							]
							if (< $arg2 $arg3) [
								uioffset $uiPad:O1- 0 [
									uicolor 0 $uiPad:O2 $y
									uioutline 0 $uiPad:O2 $y
								]
							]
						] ; uialign- -1
					] ]
					uioutline 0 $arg1 $h
					uioutline 0 $x $y
				]
				uifill 0 (*f $uiPad:O1 0.5) // pixel alignment fix
			] ; uialign- 1 1
			uiFastImg "" "hud/" $arg4 "" (*f $h 2)
			uialign- -1 1
		] ; uialign- 1
	] [
		uicolor 0 $arg1 $h [
			uicolor $arg6 $x $y [ if $arg2 [
				uihlist 0 [
					uiclip (minf $x (%f (max 0 $arg2) $arg3 $x)) $y [
						uihgradient $arg5 $arg7 $x $y
					]
					if (< $arg2 $arg3) [
						uioffset $uiPad:O1- 0 [
							uicolor 0 $uiPad:O2 $y
							uioutline 0 $uiPad:O2 $y
						]
					]
				] ; uialign- -1
			] ]
			uioutline 0 $arg1 $h
			uioutline 0 $x $y
		]
	]
]

.killfeed.row = [
	local ms fl fr mul
	ms = (- $getmillis $timestamp)
	if (< $ms $uiKillDecay) [
		ms = (%f $ms         $uiKillDecay 1)
		fl = (%f $uiKillFade $uiKillDecay 1)
		fr = (-f 1 $fl)
		cond [<f $ms $fl] [
			mul = (%f $ms $fl 1)
		] [>f $ms $fr] [
			mul = (-f 1 (%f (-f $ms $fr) $fl 1))
		] [ mul = 1 ]
		if (<f $ms $fr) [
			uifill 0 (*f (-f 1 $mul) $uiPad:5XL)
			uiFastImgStretched <mad:.18/.18/.18> "hud/" "row" "" [
				uialign 1 -2
				uispace $uiPad:M 0 [
					uifill 0 $uiPad:5XL
					uihlist 0 [
						if (> $arg5 127) [
							uiShadowImg "" "hud/" "bot" "" $uiPad:2XL
							uifill $uiPad:O3
						]
						uiFancyText "" $arg1 0.65 (INT:TRANS $arg7 * 2)
						if (|| [= $arg3 -2] [= $arg5 $arg6]) [
							uiFancyText "" " committed sudoku!" 0.65
							uifill $uiPad:XL
							uiShadowImg "" "hud/" "death" "" $uiPad:3XL
						] [
							if (= $arg3 -1) [ icon = "melee" ] [
								//icon = (at "shotgun smg pulse rocket railgun pistol" $arg3)
								icon = (at "pistol pistol pistol rocket pistol pistol" $arg3)
							]
							uifill $uiPad:XL
							uiShadowImg "" "hud/" $icon "_raw" (*f (gettexaspectwh (
								concatword "data/interface/hud/" $icon "_raw.png"
							)) $uiPad:3XL) $uiPad:3XL
							if $arg4 [
								uifill $uiPad:S
								uiShadowImg "" "hud/" "crit" "" $uiPad:3XL
							]
							uifill $uiPad:XL
							if (> $arg6 127) [
								uiShadowImg "" "hud/" "bot" "" $uiPad:2XL
								uifill $uiPad:O3
							]
							uiFancyText "" $arg2 0.65 (INT:TRANS $arg8 * 2)
						]
					]
				]
			] $uiPad:5XL
			uifill 0 $uiPad:L
		] [ uifill 0 (*f $mul (+f $uiPad:5XL $uiPad:L)) ]
	]
]
